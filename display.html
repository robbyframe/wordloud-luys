<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=1920, height=1080">
    <title>Word Cloud - LEVEL UP Your Show</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            width: 1920px;
            height: 1080px;
            background: transparent;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Segoe UI', 'Arial Black', sans-serif;
            overflow: hidden;
        }

        #wordCloud {
            width: 1600px;
            height: 900px;
            position: relative;
        }

        .word {
            position: absolute;
            color: white;
            font-weight: 900;
            text-shadow: 
                2px 2px 4px rgba(0, 0, 0, 0.9),
                -1px -1px 2px rgba(0, 0, 0, 0.7),
                0 0 30px rgba(255, 255, 255, 0.2);
            white-space: nowrap;
            transition: all 0.5s ease;
            cursor: default;
            user-select: none;
            letter-spacing: 0.5px;
        }

        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 32px;
            font-weight: 700;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.8);
        }

        .hidden {
            opacity: 0;
            pointer-events: none;
        }

        /* Fade in animation for new words */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: scale(0.8);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .word.new {
            animation: fadeIn 0.5s ease;
        }
    </style>
</head>
<body>
    <div class="loading" id="loading">Memuat word cloud...</div>
    <div id="wordCloud"></div>

    <script>
        const SUPABASE_URL = 'https://qeoszqrunkgqkoolqbpa.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFlb3N6cXJ1bmtncWtvb2xxYnBhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2MDQzMTgsImV4cCI6MjA4MDE4MDMxOH0.h_Xnid8Jnnmi-yr3YraB-I9GhTX-H6b9952hO90Mqxg';

        // Get room ID from URL parameter
        const urlParams = new URLSearchParams(window.location.search);
        const roomId = urlParams.get('room') || 'default';

        console.log('ðŸŽ¯ Word Cloud loaded for room:', roomId);

        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        const wordCloudContainer = document.getElementById('wordCloud');
        const loading = document.getElementById('loading');

        let currentWords = new Map(); // word -> {count, element}
        let maxCount = 1;

        // Layout configuration
        const CONTAINER_WIDTH = 1600;
        const CONTAINER_HEIGHT = 900;
        const PADDING = 50;
        const MIN_FONT_SIZE = 28;
        const MAX_FONT_SIZE = 140;

        async function fetchWords() {
            try {
                const { data, error } = await supabase
                    .from('word_cloud')
                    .select('*')
                    .eq('room_id', roomId)
                    .order('count', { ascending: false });

                if (error) throw error;

                // Hide loading
                if (loading.classList.contains('loading')) {
                    loading.classList.add('hidden');
                }

                if (!data || data.length === 0) {
                    console.log('No words yet');
                    return;
                }

                // Update max count for sizing
                maxCount = Math.max(...data.map(w => w.count), 1);

                // Update display
                updateWordCloud(data);

            } catch (e) {
                console.error('Error fetching words:', e);
                loading.textContent = 'Room tidak ditemukan: ' + roomId;
            }
        }

        function calculateFontSize(count) {
            // Logarithmic scale untuk better distribution
            const ratio = Math.log(count + 1) / Math.log(maxCount + 1);
            return MIN_FONT_SIZE + (MAX_FONT_SIZE - MIN_FONT_SIZE) * ratio;
        }

        function findPosition(word, fontSize) {
            // Spiral placement algorithm untuk better distribution
            const centerX = CONTAINER_WIDTH / 2;
            const centerY = CONTAINER_HEIGHT / 2;
            
            // Estimate text dimensions
            const estimatedWidth = word.length * fontSize * 0.55;
            const estimatedHeight = fontSize * 1.2;
            
            // Try center first for large words
            if (fontSize > 80 && !hasCollision(centerX - estimatedWidth/2, centerY - estimatedHeight/2, estimatedWidth, estimatedHeight)) {
                return {
                    x: centerX - estimatedWidth/2,
                    y: centerY - estimatedHeight/2
                };
            }
            
            // Spiral outward from center
            const angleStep = 0.5; // Radians per step
            const radiusStep = 8; // Pixels per step
            let angle = 0;
            let radius = 50;
            
            for (let i = 0; i < 500; i++) {
                const x = centerX + radius * Math.cos(angle) - estimatedWidth/2;
                const y = centerY + radius * Math.sin(angle) - estimatedHeight/2;
                
                // Check bounds
                if (x < PADDING || x + estimatedWidth > CONTAINER_WIDTH - PADDING) {
                    angle += angleStep;
                    radius += radiusStep;
                    continue;
                }
                
                if (y < PADDING || y + estimatedHeight > CONTAINER_HEIGHT - PADDING) {
                    angle += angleStep;
                    radius += radiusStep;
                    continue;
                }
                
                // Check collision
                if (!hasCollision(x, y, estimatedWidth, estimatedHeight)) {
                    return { x, y };
                }
                
                // Spiral outward
                angle += angleStep;
                if (angle > Math.PI * 2) {
                    angle = 0;
                    radius += radiusStep;
                }
            }
            
            // Fallback: random position
            return {
                x: PADDING + Math.random() * (CONTAINER_WIDTH - PADDING * 2 - estimatedWidth),
                y: PADDING + Math.random() * (CONTAINER_HEIGHT - PADDING * 2 - estimatedHeight)
            };
        }

        function hasCollision(x, y, width, height) {
            const existingElements = Array.from(wordCloudContainer.children);
            const margin = 15; // Space between words
            
            for (const el of existingElements) {
                if (!el.classList.contains('word')) continue;
                
                const rect = el.getBoundingClientRect();
                const containerRect = wordCloudContainer.getBoundingClientRect();
                
                const elX = el.offsetLeft;
                const elY = el.offsetTop;
                const elWidth = rect.width;
                const elHeight = rect.height;
                
                // AABB collision with margin
                if (x < elX + elWidth + margin &&
                    x + width + margin > elX &&
                    y < elY + elHeight + margin &&
                    y + height + margin > elY) {
                    return true;
                }
            }
            
            return false;
        }

        function updateWordCloud(words) {
            const newWordMap = new Map();
            
            words.forEach(wordData => {
                newWordMap.set(wordData.word, wordData);
            });

            // Update existing words
            currentWords.forEach((data, word) => {
                if (newWordMap.has(word)) {
                    const newData = newWordMap.get(word);
                    if (newData.count !== data.count) {
                        // Update size
                        const fontSize = calculateFontSize(newData.count);
                        data.element.style.fontSize = fontSize + 'px';
                        data.count = newData.count;
                    }
                } else {
                    // Word removed (optional: fade out)
                    data.element.remove();
                    currentWords.delete(word);
                }
            });

            // Add new words
            newWordMap.forEach((wordData, word) => {
                if (!currentWords.has(word)) {
                    const fontSize = calculateFontSize(wordData.count);
                    const position = findPosition(word, fontSize);
                    
                    const wordElement = document.createElement('div');
                    wordElement.className = 'word new';
                    wordElement.textContent = word;
                    wordElement.style.fontSize = fontSize + 'px';
                    wordElement.style.left = position.x + 'px';
                    wordElement.style.top = position.y + 'px';
                    
                    wordCloudContainer.appendChild(wordElement);
                    
                    currentWords.set(word, {
                        count: wordData.count,
                        element: wordElement
                    });
                    
                    // Remove 'new' class after animation
                    setTimeout(() => {
                        wordElement.classList.remove('new');
                    }, 500);
                }
            });
        }

        // Realtime subscription
        supabase
            .channel('word-cloud-' + roomId)
            .on('postgres_changes', 
                { event: '*', schema: 'public', table: 'word_cloud', filter: 'room_id=eq.' + roomId },
                (payload) => {
                    console.log('ðŸ”¥ Realtime update:', payload);
                    fetchWords();
                }
            )
            .subscribe();

        // Fetch every 1 second for responsive updates
        setInterval(fetchWords, 1000);

        // Initial fetch
        fetchWords();

        console.log('âœ… Word Cloud ready for room:', roomId);
    </script>
</body>
</html>
